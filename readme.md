
# Phobos

Phobos is (supposed to be) an optimizing bytecode compiler for Lua with some language extensions and a type system.

It's currently for Lua 5.2 (and limited to a specific Lua configuration. I think it's default though. See [constants.lua](src/constants.lua) for what Lua header it's using.)

**Note that there are a lot of things in this project that are written down or even implemented but are not set in stone.**

## Conversions, Formatter or Optimizer

Phobos shall be able to convert between several data structures, like:
- code <=> AST
- AST <=> AST (to achieve code formatting or optimizing)
- AST <=> bytecode

Phobos may also have way to write bytecode more directly, like disassembly or something.

## Better Debug Symbols

Phobos generated bytecode can also have better debug symbols.
Phobos also provides extra debug information beyond what regular Lua bytecode supports (like instruction column information). The Lua VM won't do anything with this, but other tools may read this information, such as debuggers. See [phobos_debug_symbols.md](phobos_debug_symbols.md) for how phobos provides this information.

## Language Extensions

None of these are implemented yet. Phobos syntax is currently equivalent to Lua 5.2 syntax.

There are also more planned than there are listed below.

### Safe Chaining Operators

The operators `?.`, `?:`, `?[]` and `?()` to replace the common Lua idiom
`foo and foo.bar`. These allow more efficient re-use of intermediate results in deeply nested optional objects. `?.`, `?:` and `?[]` protect an indexing operation, while `?()` protects a function call, calling the function only if it exists.

### Block Initializer Clauses

Modified versions of several block constructs allow defining block locals in the opening condition of the block.

```lua
if name_list = exp_list then ... end

do
  local name_list = exp_list
  if select(1,name_list) then ... end
end
```

```lua
while name_list = exp_list do ... end

do
  local name_list = exp_list
  while select(1,name_list) do
    ...
    name_list = exp_list
  end
end
```

### Compact Expression-body Lambda

Lua's existing function syntax is already fairly compact, but for the specific case of a function which simply returns an exp_list it can be reduced further:

```lua
(foo,bar) => foo?[bar]
```

# Compiling with Phobos

Clone the repo and init and or update all submodules. something like this should work:
```
git submodule init
git submodule update
```

Currently there are Windows Lua and LFS binaries in the root dir of the repo, so just clone the repo and try running this in the root directory. if it is successful, phobos will most likely run properly.
```
bin/windows/lua52.exe -- entry_point.lua src tests/compile_test.lua
```
<!-- cSpell:ignore luarocks -->
(for other platforms you'll somehow have to get those binaries. LFS is on luarocks, for the record)

`main.lua` is the main entry point for phobos which can only compile right now.\
The arg parser does not print the most helpful help messages yet so you may want to read the arg config in the src/main.lua file for info about args.

To actually run the main.lua file when you cloned the repository (the only option at the moment) you'll have to run src/main.lua like this (with additional args of course)
```
bin/windows/lua52.exe -- entry_point.lua src src/main.lua
```

When compiling for factorio you'd most likely want to set `--use-load` and `--source-name @__mod-name__/?` (mod-name being your mod name) with just `--source` (pointing to your mod root) and no `--output` in order to compile all `.pho` files in the mod folder (and sub folders) into `.lua` files relative next to the source files. Optionally with `--ignore` of course.

# Libraries, Dependencies and Licenses

Phobos itself is licensed under the MIT License, see [LICENSE.txt](LICENSE.txt).

<!-- cSpell:ignore Kulchenko, Mischak -->

- [Lua](https://www.lua.org/home.html) MIT License, Copyright (c) 1994â€“2021 Lua.org, PUC-Rio.
- [LuaFileSystem](https://keplerproject.github.io/luafilesystem/) MIT License, Copyright (c) 2003 - 2020 Kepler Project.
- [Serpent](https://github.com/pkulchenko/serpent) MIT License, Copyright (c) 2012-2018 Paul Kulchenko (paul AT kulchenko DOT com) (_email "encrypted" for scraping reasons_)
- [LFSClasses](https://github.com/JanSharp/LFSClasses) The Unlicense
- [LuaArgParser](https://github.com/JanSharp/LuaArgParser) MIT License, Copyright (c) 2021 Jan Mischak
- [LuaPath](https://github.com/JanSharp/LuaPath) The Unlicense
- [FactorioSumnekoLuaPlugin](https://github.com/JanSharp/FactorioSumnekoLuaPlugin) MIT License, Copyright (c) 2021 Jan Mischak, justarandomgeek

For license details see the [LICENSE_THIRD_PARTY.txt](LICENSE_THIRD_PARTY.txt) file and or the linked repositories above.

# Contributors

Huge thanks to justarandomgeek for starting the project in the first place (writing the majority of the first iteration of the parser and starting on the actual compiler) and then helping me understand several parts of compilers in general, the Lua VM, Lua bytecode and Lua internals.

Thanks to the factorio modding community for providing input, ideas and discussion about phobos as a whole. Without several people wanting types and no longer wanting to micro optimize their code phobos would have never happened.

# Contributing

Phobos is still in it's early stages (i would say anyway) and i plan on refactoring several things multiple times over before i'd really suggest anyone to contribute to the project through PRs (pull requests). I have not written down the ideals and goals behind phobos yet either, but one of the big points is to not feature creep.
